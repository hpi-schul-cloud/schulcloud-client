{{#content "styles" mode="append"}}
    <link rel="stylesheet" href="/styles/lib/datetimepicker/jquery.datetimepicker.min.css"/>
{{/content}}
{{#content "scripts" mode="append"}}
    <script src="/vendor/ckeditor/ckeditor.js" defer></script>
    <script src="/scripts/mousetrap/mousetrap.js" defer></script>
    <script src="/scripts/jquery/jquery.datetimepicker.full.min.js" type="text/javascript" defer></script>
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            CKEDITOR.replaceAll(function (textarea, config) {
                if (!textarea.classList.contains("customckeditor")) return false; //for only assign a class
            });
            
            $.datetimepicker.setLocale('de');
            $('input[data-datetime]').datetimepicker({
                format:'d.m.Y H:i',
                mask: '39.19.9999 29:59',
                onShow:function(ct, input){
                    if(input[0].id == "availableDate"){
                        let due = $("#dueDate").val().split(" ");
                        console.log(due[0]);
                        this.setOptions({
                            minDate:0,
                            maxDate:(due[0]!="__.__.____")?due[0]:false,
                            formatDate:'d.m.Y',
                        });
                    }
                    else if(input[0].id == "dueDate"){
                        let available = $("#availableDate").val().split(" ");
                        this.setOptions({
                            minDate:(available[0]!="__.__.____")?available[0]:0,
                            maxDate:false,
                            formatDate:'d.m.Y'
                        });
                    }
                }
            });

            Mousetrap.bind(['command+s', 'ctrl+s'], function(e) {
                document.getElementById('homework-form').submit();
                return false;
            });

            $("#coursePicker").change(function(e,s){
                if(s.selected!=""){
                    $('#lessonPicker').empty().append('<option value="">loading...</option>')
                    $('#lessonPicker').prop('disabled', true).trigger('chosen:updated');
                    $.ajax({
                        url: "/courses/"+s.selected+"/json"
                    }).done(function( r ) {
                        let lessonPicker = $('#lessonPicker').empty();
                        if(r.lessons.data.length > 0){
                            lessonPicker.append('<option value="">Keine Zuordnung</option>');
                            for (var i = 0; i < r.lessons.data.length; i++){
                                $('#lessonPicker').append('<option value="'+r.lessons.data[i]._id+'">'+r.lessons.data[i].name+'</option>');
                            }
                        }else{
                            lessonPicker.append('<option value="">Keine Themen in diesem Kurs</option>');
                        }
                        $('#lessonPicker').prop('disabled', false).trigger('chosen:updated');
                    });
                }else{
                    $('#lessonPicker').empty().append('<option value="">Keine Themen in diesem Kurs</option>').prop('disabled', true).trigger("chosen:updated");
                }
            });
        });
    </script>
{{/content}}
{{#extend "homework/homework"}}
    {{#content "page"}}
        <form class="modal-form" id="homework-form" method="post" action="{{action}}">
            {{#if method}}
                <input type="hidden" name="_method" data-force-value="true" value="{{method}}" />
            {{/if}}

            {{#if referrer}}﻿<input name="referrer" type="hidden" data-force-value="true" value="{{referrer}}" />{{/if}}

            ﻿<input name="schoolId" type="hidden" data-force-value="true" value="{{currentSchool}}" />

            <input name="teacherId" type="hidden" data-force-value="true" value="{{currentUser._id}}" />

            <div class="form-group">
                <label>Titel</label>
                <input class="form-control" name="name" type="text" placeholder="Titel" required value="{{assignment.name}}"/>
            </div>

            <div class="form-group">
                <label>Kurs</label>
                <select name="courseId" id="coursePicker" data-placeholder="Kurs auswählen" >
                    <option value="" {{#unless assignment.courseId}}selected{{/unless}}>Keine Zuordnung</option>
                    {{#each courses}}
                        <option value="{{this._id}}" {{#ifvalue this._id value=@root.assignment.courseId._id}}selected{{/ifvalue}}>{{this.name}}</option>
                    {{/each}}
                </select>
                <label>Thema</label>
                <select name="lessonId" id="lessonPicker" data-placeholder="Thema auswählen" {{#unless lessons}}disabled="true"{{/unless}}>
                    {{#if assignment.courseId}}
                        <option value="" {{#unless assignment.lessonId}}selected{{/unless}}>Keine Zuordnung</option>
                        {{#each lessons}}
                            <option value="{{this._id}}" {{#ifvalue this._id value=@root.assignment.lessonId}}selected{{/ifvalue}}>{{this.name}}</option>
                        {{/each}}
                    {{else}}
                        <option value="" >Keine Themen in diesem Kurs</option>
                    {{/if}}
                </select>
            </div>

            <div class="form-group">
                <label>Aufgabenstellung</label>
                <textarea name="description" type="text" class="form-control customckeditor" placeholder="Aufgabenstellung">{{assignment.description}}</textarea>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Bearbeitungszeit von</label>
                        <input class="form-control" data-datetime name="availableDate" id="availableDate" type="text" value="{{assignment.availableDate}}"/>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>bis</label>
                        <input class="form-control" data-datetime name="dueDate" id="dueDate" type="text" value="{{assignment.dueDate}}"/>
                    </div>
                </div>
            </div>

            {{#unless isStudent}}
            <div class="form-group">
                <label>
                    <input name="private" type="checkbox" value="private" {{#if assignment.private}}checked="checked"{{/if}}/>
                    Private Aufgabe (nur für mich sichtbar)
                </label></br>
                <label>
                    <input name="publicSubmissions" type="checkbox" value="public" {{#if assignment.publicSubmissions}}checked="checked"{{/if}}/>
                    Schülerabgaben untereinander sichtbar
                </label>
            </div>
            {{else}}
            <div class="form-group">
                <input name="private" type="hidden" data-force-value="true" value="private" />
            </div>
            {{/unless}}




            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-close" onclick="window.history.back();">
                    {{closeLabel}}
                </button>

                <button type="submit" class="btn btn-primary btn-submit">
                    {{submitLabel}}
                </button>
            </div>
        </form>
    {{/content}}
{{/extend}}
